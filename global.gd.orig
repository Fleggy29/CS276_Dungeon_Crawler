class_name Global extends Node

static var player = null
const TILESIZE = 64
@onready var camera := $Camera2D
@onready var inv := $Inventory
<<<<<<< HEAD
@onready var worldGen := $WorldGenerator

static var shouldGenerate = true
=======
@onready var world = $WorldGenerator
>>>>>>> 668d9cf60d39daddee6ee70f006a34cb03ea967e

var config = ConfigFile.new()

func _ready() -> void:
<<<<<<< HEAD
	player = $Player
	camera.position = player.global_position

	if shouldGenerate:
		worldGen.seed = 0 
		if worldGen.seed == 0:
			worldGen.rng.randomize()
			worldGen.seed = worldGen.rng.randi()
		worldGen.generate_world()
	else:
		load_game()
		worldGen.generate_world()

	
	inv.position = camera.position - get_viewport().get_visible_rect().size / 2


=======
	var room_rect: Rect2i = Rect2i(Vector2i(0, 0), get_viewport().get_visible_rect().size)
	$Camera2D.global_position = room_rect.position + room_rect.size / 2
	#print(player,0)
	#world.enemies_generator.give_player_world($Player, world)
>>>>>>> 668d9cf60d39daddee6ee70f006a34cb03ea967e

func _process(delta: float) -> void:
	if Input.is_key_label_pressed(KEY_ESCAPE):
		save_game()
		get_tree().change_scene_to_file("res://Menu/main_menu.tscn")
	else:
		camera.position = $Player.global_position
		inv.position = camera.position - get_viewport().get_visible_rect().size/2


func save_game() -> void:
	var player_props := {}
	var prop_names := []
	for p in player.get_property_list():
		prop_names.append(p.name)


	player_props.position = [player.global_position.x, player.global_position.y]

	player_props.velocity = [player.velocity.x, player.velocity.y] if "velocity" in prop_names else null
	player_props.currentHP = player.currentHP if "currentHP" in prop_names else null
	var inv_serialized: Dictionary = {}
	for pos in player.inventory.keys():
		var key_string = str(pos.x) + "," + str(pos.y)
		inv_serialized[key_string] = player.inventory[pos]

	player_props.inventory = inv_serialized


	var save_dict := {
		"seed": worldGen.seed,
		"player": player_props
	}

	var json_text := JSON.stringify(save_dict)

	config.set_value("SaveState", "data", json_text)
	config.save("res://SaveData/settings.config")

	print("[Save] Game saved with seed =", worldGen.seed)


func load_game() -> void:
	var err := config.load("res://SaveData/settings.config")
	if err != OK:
		print("[Load] No save file found.")
		return

	var json_text : String = config.get_value("SaveState", "data")
	if json_text == null:
		print("[Load] No save data section found.")
		return

	var parsed = JSON.parse_string(json_text)
	if typeof(parsed) != TYPE_DICTIONARY:
		print("[Load] Invalid save data format.")
		return

	var data: Dictionary = parsed


	if data.has("seed"):
		worldGen.seed = int(data["seed"])
		print("[Load] Loaded seed =", worldGen.seed)
	else:
		print("[Load] WARNING: No seed in save!")

	
	var prop_names: Array[String] = []
	for prop in player.get_property_list():
		prop_names.append(prop.name)



	if data.has("player"):
		var p = data["player"]

		if p.has("position") and p["position"] != null:
			var pos = p["position"]
			player.global_position = Vector2(pos[0], pos[1])


		if p.has("velocity") and p["velocity"] != null and "velocity" in prop_names:
			var vel = p["velocity"]
			player.velocity = Vector2(vel[0], vel[1])


		if p.has("currentHP") and "currentHP" in prop_names:
			player.currentHP = p["currentHP"]

		if "inventory" in p and "inventory" in prop_names:
			var loaded_inventory: Dictionary[Vector2i, String] = {}
			for k_str in p["inventory"].keys():
				var parts = k_str.split(",")
				if parts.size() == 2:
					var vec = Vector2i(parts[0].to_int(), parts[1].to_int())
					loaded_inventory[vec] = str(p["inventory"][k_str])
			player.inventory = loaded_inventory



		print("[Load] Player restored.")

	print("[Load] Game restored successfully.")
